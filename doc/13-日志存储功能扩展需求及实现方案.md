# 日志存储功能扩展需求及实现方案

**版本号:** V1.0  
**项目代号:** Serial-Agent-MCP  
**创建日期:** 2025年11月24日

## 1. 项目背景

当前智能串口MCP工具的运行日志仅输出在命令行终端，无法持久化存储和后续分析。同时，串口通信的原始数据也需要按照特定格式进行记录，便于调试和协议分析。本方案旨在扩展日志存储功能，实现工具运行日志和串口通信原始数据的文件化存储。

## 2. 功能需求

### 2.1 串口通信原始数据日志

**2.1.1 创建策略**
- 按串口名和当前时间创建日志文件
- 每个连接的串口创建独立的日志文件组
- 文件名格式：`{port}_{timestamp}.{format}`，例如：`COM1_20251124_143022.hex` 和 `COM1_20251124_143022.txt`

**2.1.2 数据格式**
- 创建两个文件分别存储：
  - HEX格式文件（.hex扩展名）：存储十六进制字符串格式的原始数据
  - 字符串格式文件（.txt扩展名）：存储可读字符串格式的数据

**2.1.3 内容要求**
- 记录数据流向（发送Tx/接收Rx）
- 添加时间戳信息
- 每条记录包含：时间戳 - 数据流向 - 数据内容

**2.1.4 文件管理**
- 当串口连接断开时，关闭对应的日志文件
- 支持文件滚动策略（按大小或时间）

### 2.2 工具运行日志

**2.2.1 存储策略**
- 记录工具运行过程中的日志
- 日志文件使用时间戳命名
- 保持现有的命令行输出功能

**2.2.2 文件命名**
- 文件名格式：`serial-agent-mcp_{timestamp}.log`
- 例如：`serial-agent-mcp_20251124_143022.log`

## 3. 日志文件生命周期管理

### 3.1 串口通信日志生命周期

**创建时机：**
- 当执行 `configure_connection` 工具且 action 为 "open" 时创建日志文件

**更新时机：**
- 每次执行 `send_data` 工具时，根据实际的发送和接收操作更新日志文件

**关闭时机：**
- 当执行 `configure_connection` 工具且 action 为 "close" 时关闭日志文件
- 或工具关闭时统一清理所有打开的日志文件

**存储位置：**
- 存储在 `logs/com_log/` 目录下
- 按日期创建子目录便于管理，如 `logs/com_log/2025/11/24/`

### 3.2 工具运行日志生命周期

**创建时机：**
- 工具启动时创建新的日志文件

**更新时机：**
- 工具运行期间的所有日志输出都写入当前文件

**轮转策略：**
- 当文件大小达到预设阈值（如10MB）时，创建新文件
- 或按时间间隔（如每天）创建新文件

**存储位置：**
- 存储在 `logs/tool_log/` 目录下
- 按日期创建子目录便于管理，如 `logs/tool_log/2025/11/24/`

### 3.3 日志清理策略

**自动清理：**
- 保留最近30天的日志文件
- 定期清理超过保留期限的旧日志文件
- 可配置的保留天数参数

**手动清理：**
- 提供工具或命令支持手动清理日志文件
- 可选择清理特定日期范围或特定类型的日志

## 4. 技术实现方案

### 4.1 日志模块设计

**4.1.1 串口数据日志模块**
```python
class SerialDataLogger:
    def __init__(self, port_name):
        self.port = port_name
        self.hex_file = None
        self.txt_file = None
    
    def start_logging(self):
        # 创建HEX和TXT格式日志文件
        pass
    
    def log_data(self, direction, data_bytes):
        # 记录数据到两个文件
        pass
    
    def stop_logging(self):
        # 关闭日志文件
        pass
```

**4.1.2 工具运行日志模块**
```python
class RuntimeLogger:
    def __init__(self):
        self.runtime_handler = None
    
    def setup_runtime_logging(self):
        # 配置文件日志处理器
        pass
```

### 4.2 日志格式定义

**4.2.1 串口通信日志格式**
- HEX格式：`[2025-11-24 14:30:22.123] Tx -> 48 65 6C 6C 6F 0D 0A`
- 字符串格式：`[2025-11-24 14:30:22.123] Tx -> Hello\r\n`

**4.2.2 运行日志格式**
- `[2025-11-24 14:30:22.123] [LEVEL] Message content`

### 4.3 配置管理

**4.3.1 配置参数**
- `log_retention_days`: 日志保留天数（默认30天）
- `max_log_file_size`: 最大日志文件大小（默认10MB）
- `log_directory`: 日志存储根目录（默认'logs'）

**4.3.2 配置文件结构**
```python
{
  "logging": {
    "retention_days": 30,
    "max_file_size_mb": 10,
    "log_directory": "logs",
    "serial_data_logging": {
      "enabled": true,
      "hex_format": true,
      "text_format": true
    },
    "runtime_logging": {
      "enabled": true,
      "level": "INFO"
    }
  }
}
```

## 5. 实现步骤

### 5.1 第一阶段：基础日志框架
1. 创建日志管理类和工具
2. 实现运行时日志到文件的功能
3. 测试基础日志功能

### 5.2 第二阶段：串口数据日志
1. 实现串口通信数据的双格式记录
2. 支持按串口名创建日志文件
3. 添加时间戳和数据流向标记

### 5.3 第三阶段：生命周期管理
1. 实现日志文件的自动轮转
2. 实现日志文件的自动清理
3. 完善错误处理和资源管理

## 6. 性能考虑

### 6.1 文件I/O优化
- 使用缓冲写入减少磁盘I/O操作
- 采用异步方式写入日志，避免阻塞主要功能
